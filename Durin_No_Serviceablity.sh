#!/bin/bash
#daily reports for creation failures
#By Pratima.u

#command to source durin db config in distributed crons mesos boxes.
. /usr/share/3pl-crons/db/db_config.sh

echo ${EKL_DURIN_DB}
CWD='/home/pratima.u/DURIN_SCRIPTS'
rm durin_failure_shipments.csv

#Function to query durin db
function durin_slave() {
	echo "$1" | mysql -u${EKL_DURIN_USER} -p${EKL_DURIN_PWD} -h${EKL_DURIN_HOST} ${EKL_DURIN_DB}  -N
}

#Modify query as per needs. Change table data and insert Tracking Ids.
TID_FAILURES="select clientRequest from creation_failures_d_20230404 where vendorTrackingId in ('MYEC1000020854','MYEC1000020602','MYEC1000020599','MYEP1000026328','MYEP1000027288','MYEP1000029981','MYEP1000027908','MYEP1000032760','MYEP1000032976','MYEP1000035213','MYEP1000033165','MYEP1000034930','MYEP1000037618','MYEP1000037407','MYEC1000029754','MYEC1000029576','MYEP1000037835','MYEP1000041127','MYEP1000042259','MYEC1000031596','MYEP1000038625','MYEC1000029305','MYEC1000030073','MYEP1000041526','MYEP1000039083','MYEC1000029756','MYEP1000042326','MYEC1000033177','MYEC1000032564','MYEP1000044157','MYEC1000034023','MYEP1000042806','MYEC1000032441','MYEC1000032850','MYEC1000032671','MYEC1000033387','MYEC1000033360','MYEP1000041424','MYEP1000044265','MYEP1000046818','MYEP1000044773','MYEC1000035294','MYEC1000034498','MYEC1000034054','MYEC1000034606','MYEP1000044294','MYEP1000044986','MYEC1000034538','MYEC1000035640','MYEC1000034347','MYEC1000035399','MYEP1000045602','MYEP1000043636','MYEC1000034962','MYEC1000034122','MYEP1000048187','MYEC1000036753','MYEP1000050972','MYEC1000036794','MYEP1000047600','MYEP1000048380','MYEC1000036268','MYEP1000050974','MYEP1000050560','MYEP1000048463','MYEC1000038282','MYEP1000048580','MYEP1000046935','MYEP1000062026','MYEP1000063450','MYEC1000041533','MYEC1000046602','MYEC1000044348','MYEP1000062889','MYEP1000061779','MYEP1000059132','MYEP1000062552','MYEC1000043247','MYEP1000060145','MYEC1000045935','MYEC1000038923','MYEP1000059041','MYEP1000063062','MYEC1000044795','MYEP1000052955','MYEP1000060624','MYEP1000058232','MYEC1000043841','MYEP1000063953','MYEP1000059813','MYEC1000037810','MYEC1000045681','MYEC1000040424','MYEC1000042662','MYEC1000039784','MYEC1000043257','MYEP1000058645','MYEP1000058786','MYEP1000058438','MYEP1000059281','MYEP1000059835','MYEC1000044104','MYEP1000062460','MYEC1000045503','MYEC1000046363','MYEC1000046457','MYEP1000059334','MYEP1000057044','MYEC1000042109','MYEC1000045212','MYEP1000058544','MYEP1000063831','MYEC1000042879','MYEC1000047502','MYEP1000061692','MYEP1000061389','MYEP1000059663','MYEP1000052067','MYEP1000060502','MYEP1000053973','MYEP1000060544','MYEP1000051048','MYEP1000059257','MYEP1000061820','MYEP1000063796','MYEC1000046964','MYEP1000064470','MYEP1000052904','MYEP1000053019','MYEP1000053026','MYEP1000060895','MYEC1000044346','MYEP1000052835','MYEC1000040620','MYEP1000061599','MYEC1000044973','MYEP1000052190','MYEP1000052583','MYEP1000049454','MYEC1000044603','MYEP1000064002','MYEP1000060275','MYEC1000041836','MYEP1000058792','MYEP1000060821','MYEC1000042003','MYEP1000063258','MYEC1000044244','MYEC1000046575','MYEP1000060172','MYEP1000057552','MYEC1000045090','MYEP1000064303','MYEC1000047255','MYEP1000063601','MYEC1000040494','MYEC1000040879','MYEC1000046682','MYEP1000062921','MYEC1000044306','MYEP1000059141','MYEP1000060141','MYEP1000059407','MYEP1000063492','MYEP1000061390','MYEP1000063760','MYEP1000063918','MYEP1000063767','MYEP1000063486','MYEP1000063436','MYEP1000057362','MYEC1000046266','MYEP1000063382','MYEC1000047354','MYEC1000043539','MYEP1000063259','MYEC1000043607','MYEP1000064439','MYEP1000060586','MYEP1000063832','MYEP1000064123','MYEP1000060810','MYEP1000064241','MYEP1000059803','MYEC1000044871','MYEP1000062611','MYEC1000045361','MYEP1000062517','MYEC1000044123','MYEC1000046866','MYEC1000043121','MYEC1000044690','MYEP1000058985','MYEC1000047099','MYEP1000063488','MYEC1000047174','MYEC1000042766','MYEC1000046325','MYEC1000045337','MYEP1000058756','MYEP1000060038','MYEC1000046340','MYEC1000042909','MYEP1000060500','MYEP1000064676','MYEC1000043572','MYEP1000064481','MYEC1000047242','MYEC1000045251','MYEP1000059815','MYEC1000044995','MYEC1000045843','MYEP1000059706','MYEP1000064122','MYEP1000061367','MYEP1000064722','MYEP1000063356','MYEP1000060252','MYEP1000061483','MYEC1000042770','MYEP1000063321','MYEP1000062714','MYEP1000062715','MYEP1000061884','MYEC1000046541','MYEP1000059846','MYEP1000060383','MYEC1000045178','MYEP1000064965','MYEP1000058430','MYEP1000063354','MYEP1000063989','MYEP1000058637','MYEP1000059996','MYEC1000047247','MYEC1000046355','MYEC1000045095','MYEP1000057560','MYEP1000061391','MYEP1000061121','MYEP1000063231','MYEC1000046621','MYEP1000064788','MYEP1000055110','MYEP1000061090','MYEC1000047573','MYEC1000042406','MYEP1000061128','MYEP1000064864','MYEP1000058640','MYEP1000060249','MYEP1000061497','MYEC1000044873','MYEP1000061310','MYEC1000046600','MYEC1000043215','MYEP1000064064','MYEC1000046195','MYEC1000046264','MYEC1000046470','MYEP1000064259','MYEP1000063540','MYEP1000064729','MYEC1000044686','MYEC1000047155','MYEP1000075232','MYEC1000054208','MYEC1000056674','MYEP1000077564','MYEP1000081957','MYEC1000054206','MYEC1000056309','MYEP1000076730','MYEC1000056675','MYEC1000054452','MYEC1000056676','MYEP1000074442','MYEP1000076523','MYEP1000075518','MYEC1000055852','MYEP1000078394','MYEP1000073413','MYEP1000067388','MYEP1000066494','MYEC1000052230','MYEP1000073814','MYEP1000077128','MYEP1000077616','MYEC1000053318','MYEC1000054841','MYEC1000057220','MYEP1000077760','MYEP1000075170','MYEP1000075762','MYEP1000075562','MYEC1000049931','MYEC1000055604','MYEP1000076058','MYEC1000057085','MYEP1000076703','MYEP1000077993','MYEP1000080799','MYEC1000055218','MYEC1000055967','MYEC1000054867','MYEC1000057119','MYEP1000075979','MYEP1000077694','MYEC1000056004','MYEP1000068518','MYEP1000078050','MYEP1000077133','MYEP1000080431','MYEP1000078690','MYEC1000054955','MYEC1000055522','MYEP1000065922','MYEP1000076918','MYEP1000075066','MYEP1000079106','MYEC1000051048','MYEC1000052196','MYEC1000056483','MYEC1000056673','MYEP1000077260','MYEP1000075662','MYEP1000074077','MYEC1000054110','MYEC1000055940','MYEC1000058083','MYEC1000053871','MYEP1000077012','MYEC1000056239','MYEP1000080308','MYEP1000074668','MYEP1000074793','MYEC1000053307','MYEP1000078447','MYEP1000078217','MYEP1000065579','MYEP1000077483','MYEP1000076300','MYEC1000056392','MYEC1000056147','MYEP1000076301','MYEC1000054511','MYEP1000075641','MYEC1000056003','MYEC1000055938','MYEP1000075890','MYEC1000058316','MYEC1000054313','MYEC1000053541','MYEC1000056377','MYEC1000054507','MYEC1000055626','MYEP1000077051','MYEP1000067147','MYEP1000079105','MYEC1000053306','MYEP1000080912','MYEP1000079022','MYEC1000056535','MYEP1000076921','MYEP1000075576','MYEC1000055556','MYEP1000082094','MYEP1000080351','MYEP1000075179','MYEP1000070519','MYEP1000077679','MYEC1000054782','MYEP1000076196','MYEP1000076625','MYEC1000054191','MYEP1000078020','MYEP1000079382','MYEC1000056185','MYEP1000072334','MYEP1000074586','MYEP1000080307','MYEP1000078651','MYEC1000049745','MYEC1000053324','MYEP1000082157','MYEP1000074896','MYEP1000079397','MYEC1000053631','MYEP1000077693','MYEP1000075293','MYEC1000053570','MYEP1000080801','MYEC1000058264','MYEP1000080502','MYEC1000051436','MYEP1000077856') group by vendorTrackingId"

#Write results of query into a file
durin_slave "${TID_FAILURES}" > $CWD/durin_fail_list.csv

#read from the same file
while read message;
do
	#Parse the file for required attributes
	client_name=`echo $message|jq -r ".client_name"`
	service_code=`echo $message|jq -r ".services[].service_code"`
	service_leg=`echo $message|jq -r ".services[].service_details[].service_leg"`
	tracking_id=`echo $message|jq -r ".services[].service_details[].shipment.tracking_id"`
	client_reference_id=`echo $message|jq -r ".services[].service_details[].shipment.client_reference_id"`
	fulfillment_type=`echo $message|jq -r ".services[].service_details[].service_data.fulfillment_type"`
	if [ $fulfillment_type == "fbf" ]
	then
		source_location_code=`echo $message|jq -r ".services[].service_details[].service_data.source.location_code"`
		return_location_code=`echo $message|jq -r ".services[].service_details[].service_data.return_location.location_code"`
	else
		source_location_code=`echo $message|jq -r ".services[].service_details[].service_data.source.seller_location_id"`
		return_location_code=`echo $message|jq -r ".services[].service_details[].service_data.return_location.seller_location_id"`
	fi
	source_pincode=`echo $message|jq -r ".services[].service_details[].service_data.source.address.pincode"`

	if [ $service_leg == "FORWARD" ]
	then
		destination_pincode=`echo $message|jq -r ".services[].service_details[].service_data.destination.address.pincode"`
	else
		destination_pincode=`echo $message|jq -r ".services[].service_details[].service_data.destination.location_code"`
	fi
	return_pincode=`echo $message|jq -r ".services[].service_details[].service_data.return_location.address.pincode"`

	echo $tracking_id,$service_code,$service_leg,$client_reference_id,$source_location_code,$source_pincode,$destination_pincode,$return_location_code,$return_pincode >> $CWD/durin_failure_shipments.csv
done < $CWD/durin_fail_list.csv

#Command to add header to the beginning of the file
echo -e "TrackingId,ServiceCode,service_leg,client_reference_id,source_location_code,source_pincode,destination_pincode,return_location_code,return_pincode" | cat - durin_failure_shipments.csv > temp && mv temp durin_failure_shipments.csv
